version: '3.8'

services:
  # Titan Development Environment
  titan-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: titan-dev
    cap_add:
      - SYS_NICE      # For thread pinning (CPU affinity)
    volumes:
      - .:/workspace
      - vcpkg-cache:/opt/vcpkg/buildtrees
      - vcpkg-packages:/opt/vcpkg/packages
    ports:
      - "8080:8080"   # Titan API Gateway
      - "9090:9090"   # Titan Control Plane API
    networks:
      - titan-net
    command: tail -f /dev/null
    working_dir: /workspace

  # Mock Backend Server (for testing)
  mock-backend:
    image: python:3.11-slim
    container_name: mock-backend
    volumes:
      - ./tests/mock-backend:/app
    ports:
      - "3000:3000"
    networks:
      - titan-net
    working_dir: /app
    command: >
      sh -c "pip install fastapi uvicorn &&
             python -m uvicorn main:app --host 0.0.0.0 --port 3000"

  # Nginx Baseline (for benchmarking comparison)
  nginx-baseline:
    image: nginx:alpine
    container_name: nginx-baseline
    volumes:
      - ./benchmark/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "8081:8081"
    networks:
      - titan-net

volumes:
  vcpkg-cache:
  vcpkg-packages:

networks:
  titan-net:
    driver: bridge
