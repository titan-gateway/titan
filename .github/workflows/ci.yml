name: CI

on:
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-branch:
    name: Validate Branch Name
    runs-on: ubuntu-latest
    steps:
      - name: Check branch prefix
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Branch: $BRANCH"
          if [[ ! "$BRANCH" =~ ^(epic|feat|fix|chore)/ ]]; then
            echo "❌ Branch name must start with: epic/, feat/, fix/, or chore/"
            echo "   Current branch: $BRANCH"
            exit 1
          fi
          echo "✅ Branch name is valid: $BRANCH"

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    needs: validate-branch
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache clang-format-21
        id: cache-clang-format
        uses: actions/cache@v4
        with:
          path: /usr/bin/clang-format-21
          key: clang-format-21-${{ runner.os }}

      - name: Install clang-format-21
        if: steps.cache-clang-format.outputs.cache-hit != 'true'
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 21
          sudo apt-get install -y clang-format-21

      - name: Check C++ formatting
        run: make format-check

      - name: Check for TODO/FIXME comments
        run: |
          echo "Scanning for TODO/FIXME comments..."
          if grep -rn "TODO\|FIXME" src/ tests/ --include="*.cpp" --include="*.hpp" 2>/dev/null; then
            echo "⚠️  Found TODO/FIXME comments (informational only)"
          else
            echo "✅ No TODO/FIXME comments found"
          fi

  build-test:
    name: Build & Test
    runs-on: ubuntu-24.04
    needs: [validate-branch, code-quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # Add GCC 14 repository
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test

          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            gcc-14 \
            g++-14 \
            libstdc++-14-dev \
            binutils \
            pkg-config \
            python3 \
            python3-pip \
            lcov

      - name: Setup vcpkg cache
        uses: actions/cache@v4
        with:
          path: |
            /opt/vcpkg
            ~/.cache/vcpkg
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Setup vcpkg
        run: |
          if [ ! -d "/opt/vcpkg" ]; then
            git clone https://github.com/microsoft/vcpkg.git /opt/vcpkg
            /opt/vcpkg/bootstrap-vcpkg.sh
          fi
          echo "VCPKG_ROOT=/opt/vcpkg" >> $GITHUB_ENV

      - name: Setup build cache
        uses: actions/cache@v4
        with:
          path: |
            build/dev
            ~/.cache/ccache
          key: build-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            build-${{ runner.os }}-

      - name: Build and Test (with coverage)
        run: make test-coverage

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

      - name: Upload titan binary
        uses: actions/upload-artifact@v4
        with:
          name: titan-binary
          path: build/dev/src/titan
          retention-days: 1

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-24.04
    needs: build-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download titan binary
        uses: actions/download-artifact@v4
        with:
          name: titan-binary
          path: build/dev/src

      - name: Make binary executable
        run: chmod +x build/dev/src/titan

      - name: Install Python test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install --break-system-packages -r tests/integration/requirements.txt
          pip3 install --break-system-packages -r tests/mock-backend/requirements.txt

      - name: Run Integration Tests
        run: |
          cd tests/integration
          pytest -v --tb=short

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-24.04
    needs: integration-test
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            gcc-14 \
            g++-14 \
            libstdc++-14-dev

      - name: Setup vcpkg cache
        uses: actions/cache@v4
        with:
          path: |
            /opt/vcpkg
            ~/.cache/vcpkg
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Setup vcpkg
        run: |
          if [ ! -d "/opt/vcpkg" ]; then
            git clone https://github.com/microsoft/vcpkg.git /opt/vcpkg
            /opt/vcpkg/bootstrap-vcpkg.sh
          fi
          echo "VCPKG_ROOT=/opt/vcpkg" >> $GITHUB_ENV

      - name: Setup build cache
        uses: actions/cache@v4
        with:
          path: |
            build/dev
            ~/.cache/ccache
          key: build-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            build-${{ runner.os }}-

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: cpp
          queries: security-extended,security-and-quality

      - name: Build for CodeQL analysis
        run: |
          cmake --preset=dev
          cmake --build --preset=dev --target titan

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:cpp"
